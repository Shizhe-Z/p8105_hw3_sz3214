---
title: "p8105_hw3_sz3214"
author: "Shizhe Zhang"
date: "2024-10-08"
output: html_document

---

```{r setup, include=FALSE}
library(tidyverse)
library(dplyr)
library(ggplot2)
library(patchwork)
```

# Problem 1

**load data**
```{r}
library(p8105.datasets)
data("ny_noaa")
```

**Overall**
```{r}
str(ny_noaa)
colMeans(is.na(ny_noaa)) * 100
```

The dataset consists of 2,595,176 rows and 7 columns. Each row represents a daily weather observation, and the key variables include:

`id`: A character variable identifying the weather station.
`date`: A date variable representing the date of the observation.
`prcp`: An integer variable indicating precipitation.
`snow`: An integer variable for snowfall measurements.
`snwd`: An integer variable for snow depth.
`tmax`: A character variable representing the maximum temperature for the day.
`tmin`: A character variable representing the minimum temperature.

Several key variables contain many NA values: 

`prcp`: 5.62% missing value.
`snow`: 14.69% missing value.
`snwd`: 22.80% missing value.
`tmax`: 43.71% missing value.
`tmin`: 43.71% missing value.

**data cleaning**
```{r}
ny_noaa = ny_noaa |> 
  janitor::clean_names() |> 
  mutate(year = as.numeric(format(date, "%Y")),
         month = as.numeric(format(date, "%m")),
         day = as.numeric(format(date, "%d")),
         tmax = as.integer(tmax) / 10,
         tmin = as.integer(tmin) / 10,
         prcp = prcp / 10)

ny_noaa |> 
  group_by(snow) |> 
  summarise(count = n()) |> 
  arrange(desc(count)) |> 
  head(n=5)
```
The most commonly observed value for snowfall is 0. 

**plot 1**
```{r}
ny_noaa |> 
  filter(month == '1' | month == '7') |> 
  group_by(year, month) |> 
  summarise(avg_tmax = mean(tmax, na.rm = TRUE), .groups = "drop") |> 
  ungroup() |> 
  ggplot(aes(x = year, y = avg_tmax)) +
  geom_point() +
  facet_wrap(~month) +
  labs(
    title = "Average Max Temperature in January and July Across Years",
    x = "Year", y = "Average Max Temperature (°C)"
  ) 
```
There is a gradual increase around 0°C in temperatures  over time in Jan. In July, the temperatures are around 25-30°C across all years and didn't show obviously trend.
In the January, there are a few data points slightly above or below 0°C, which could be outliers.

**plot 2**
```{r}
tmax_tmin = ny_noaa |> 
  filter(!is.na(tmax) & !is.na(tmin)) |> 
  ggplot(aes(x=tmin, y=tmax)) +
  geom_hex(bins = 30) +
  labs(title = "Hexbin Plot of Tmax vs Tmin", x = "Tmin (°C)", y = "Tmax (°C)")

snow_dist = ny_noaa |> 
  filter(snow > 0 & snow < 100) |> 
  ggplot(aes(x=year, y=snow)) +
  geom_violin() +
  labs(title = "Snowfall Distribution (0 < Snowfall < 100) by Year", x = "Snowfall (mm)", y = "Year")

tmax_tmin + snow_dist
```


# Problem 2

**data cleaning**
```{r}
accel = read.csv("nhanes_accel.csv") |> 
  janitor::clean_names()

covar = read.csv("nhanes_covar.csv", skip = 4) |> 
  janitor::clean_names() |> 
  filter(age >= 21, !is.na(sex), !is.na(age), !is.na(bmi), !is.na(education)) |> 
  mutate(
    sex = factor(sex, levels = c(1, 2), labels = c("Male", "Female")),
    education = factor(education, 
                          levels = c(1, 2, 3), 
                          labels = c("Less than high school", 
                                     "High school equivalent", 
                                     "More than high school"))
  )

mims = inner_join(accel, covar, by = "seqn")
```

**table and plot**
```{r}
mims |> 
  group_by(sex, education) |> 
  summarize(count = n()) |> 
  pivot_wider(
    names_from = sex,
    values_from = count
  ) |> 
  knitr::kable()

mims |>
  group_by(sex, education) |> 
  ggplot(aes(x = sex, y = age, color = education)) +
  geom_boxplot() +
  labs(
    title = "Age distributions for men and women in each education category",
    x = "Sex", y = "Age"
  ) 
```
The "Less than high school" group shows a near-equal representation of men and women.
There is a noticeable difference in the "High school equivalent" category, where men outnumber women.
For the "More than high school" group, the balance between genders is relatively even, slightly favoring women. The "More than high school" group has the widest age range.

**activity vs age**
```{r}
mims |> 
  rowwise() |>
  mutate(activity = sum(c_across(starts_with("min")), na.rm = TRUE)) |> 
  ungroup() |> 
  group_by(sex, education) |> 
  ggplot(aes(x = age, y = activity, color = sex)) +
  geom_point(alpha = 0.6) + 
  geom_smooth(method = "loess") +
  facet_wrap(~education) +
  labs(
    title = "Total Activity vs. Age by Sex and Education Level",
    x = "Age", y = "Total Daily Activity"
  ) 
```
Higher education levels are associated with more consistent activity patterns across the lifespan, while lower education levels show more variability and a steeper decline in activity, especially for women. Gender differences are more pronounced in the lower education groups, with women showing higher activity at younger ages but a sharper decline as they age.

**24-Hour activity courses**
```{r}
mims |> 
  pivot_longer(cols = starts_with("min"), 
               names_to = "minute", 
               names_prefix = "min", 
               values_to = "activity") |> 
  mutate(minute = as.numeric(minute))  |> 
  group_by(minute, sex, education) |> 
  summarize(mean_activity = mean(activity, na.rm = TRUE)) |> 
  ggplot(aes(x = minute, y = mean_activity, color = sex)) +
  geom_point(alpha = 0.1) +
  geom_smooth(size = 1.2) +
  facet_wrap(~education, nrow = 3) +
  scale_x_continuous(breaks = seq(0, 1440, by = 120), 
                     labels = function(x) sprintf("%02d:00", x / 60)) +
  labs(title = "24-Hour Activity Time Courses by Education Level and Sex",
       x = "Time of Day",
       y = "Mean Activity Level",
       color = "Sex") 
```
While there are slight variations in the timing and magnitude of activity peaks, the overall daily activity pattern remains similar across all three education levels. Individuals have lower activity levels during the early morning and late night, with peaks in the late morning and early afternoon.

Women tend to have higher morning activity levels, especially in the more educated groups. Men tend to have slightly higher afternoon and evening activity levels, especially in the "Less than high school" group.

Individuals with higher education levels ("More than high school") seem to maintain higher and more consistent activity levels throughout the day, whereas those with lower education levels ("Less than high school") have lower overall activity and experience earlier declines in activity. 


# Problem 3

**data cleaning**
```{r}
bike201 <- read.csv("citibike/Jan 2020 Citi.csv") |> 
  janitor::clean_names() |> 
  mutate(year = 2020, month = "Jan")
bike207 <- read.csv("citibike/July 2020 Citi.csv") |> 
  janitor::clean_names() |> 
  mutate(year = 2020, month = "July")
bike241 <- read.csv("citibike/Jan 2024 Citi.csv") |> 
  janitor::clean_names() |> 
  mutate(year = 2024, month = "Jan")
bike247 <- read.csv("citibike/July 2024 Citi.csv") |> 
  janitor::clean_names() |> 
  mutate(year = 2024, month = "July")

citibike = bind_rows(bike201, bike207, bike241, bike247) 

str(citibike)
```

The final dataset contains 99485 observations with 9 variables including:
`ride_id`, `rideable_type`, `weekdays`, `duration`, `start_station_name`, `end_station_name`, 
`member_casual`, `year`, `month`.

**table 1**
```{r}
citibike |> 
  group_by(year, month, member_casual) |>
  summarize(number = n()) |> 
  pivot_wider(
    names_from = member_casual,
    values_from = number) |> 
  knitr::kable()
```
From 2020 to 2024, there is notable growth in total rides, especially in July 2024, where ridership has surged. This suggests increased popularity and perhaps expanded infrastructure or public interest in bike-sharing.

**table 2**
```{r}
citibike |> 
  filter(year == 2024, month == "July") |>  
  group_by(start_station_name) |>  
  summarize(total_ride = n()) |>  
  arrange(desc(total_ride)) |>  
  slice_max(total_ride, n = 5) |>
  knitr::kable(caption = "Top 5 Most Popular Starting Stations for July 2024")
```












